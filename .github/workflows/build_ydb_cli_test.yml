name: Build-YDB-CLI-Test
run-name: Build YDB CLI Test

permissions:
  contents: write
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      version-change:
        description: "PATCH for bug fixes, MINOR for new features"
        required: true
        type: choice
        options:
          - PATCH
          - MINOR
          - MAJOR
        default: PATCH
      commit_sha:
        description: Do not change this unless you know what you are doing
        type: string
        default: ""
      build-linux-amd:
        type: boolean
        description: Build YDB CLI for Linux (amd64)
        default: true
      build-linux-arm:
        type: boolean
        description: Build YDB CLI for Linux (arm64)
        default: true
      build-darwin-amd:
        type: boolean
        description: Build YDB CLI for MacOS (amd64)
        default: true
      build-darwin-arm:
        type: boolean
        description: Build YDB CLI for MacOS (arm64)
        default: true
      build-windows-amd:
        type: boolean
        description: Build YDB CLI for Windows (amd64)
        default: true

defaults:
  run:
    shell: bash

jobs:
  prepare-release:
    name: Prepare release branch and update version
    runs-on: ubuntu-latest
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      new-version: ${{ steps.update-version.outputs.new-version }}
    steps:
      - name: Print input parameters
        run: |
          echo "=== YDB CLI Test Build Parameters ==="
          echo "Version change: ${{ inputs.version-change }}"
          echo "Commit SHA: ${{ inputs.commit_sha }}"
          echo "Build platforms:"
          echo "  - Linux AMD64: ${{ inputs.build-linux-amd }}"
          echo "  - Linux ARM64: ${{ inputs.build-linux-arm }}"
          echo "  - macOS AMD64: ${{ inputs.build-darwin-amd }}"
          echo "  - macOS ARM64: ${{ inputs.build-darwin-arm }}"
          echo "  - Windows AMD64: ${{ inputs.build-windows-amd }}"
          echo "====================================="

      - name: Set CLI version
        id: update-version
        run: |
          # For testing, use fixed version
          # In production, this would be calculated from inputs.version-change and current version
          CLI_VERSION="2.27.0"
          echo "new-version=$CLI_VERSION" >> $GITHUB_OUTPUT
          echo "CLI version set to: $CLI_VERSION"
          
          # Create version file for artifact
          echo "$CLI_VERSION" > cli_version.txt

      - name: Create release branch
        id: create-branch
        run: |
          # Simulate branch creation for testing
          BRANCH_NAME="cli-release/${{ steps.update-version.outputs.new-version }}"
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"

      - name: Upload CLI version artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-version
          path: cli_version.txt

  test-build:
    name: Test Build Process
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: Simulate build process
        run: |
          echo "🚀 Starting simulated build process..."
          echo "📦 Preparing build environment..."
          echo "🔧 CLI Version: ${{ needs.prepare-release.outputs.new-version }}"
          sleep 10
          echo "🔨 Building binaries for selected platforms..."
          sleep 20
          echo "📤 Uploading to S3..."
          sleep 10
          echo "✅ Build process completed successfully!"

      - name: Wait for 1 minute
        run: |
          echo "⏳ Waiting 1 minute to simulate real build time..."
          sleep 30
          echo "✅ Test workflow completed successfully!"
